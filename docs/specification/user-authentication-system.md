# ユーザー認証システム仕様書

## 概要
AutoDealerSphereにユーザー認証機能を追加し、ユーザー管理と権限制御を実装する。

## 実装日
2025年8月1日

## 1. データモデル

### 1.1 Userテーブルの拡張
既存のUserモデルに以下のフィールドを追加：

| フィールド名 | 型 | 必須 | デフォルト値 | 説明 |
|------------|---|-----|------------|------|
| Password | string | ○ | "" | ユーザーのパスワード（現在は平文、将来的にハッシュ化予定） |
| Role | int | ○ | 1 | ユーザーの権限レベル |

### 1.2 権限レベル
- Role = 1: 一般ユーザー
- Role = 2: 管理者

## 2. 画面構成

### 2.1 ログイン画面（Index.razor）
- **パス**: `/`
- **機能**: システムへのログイン
- **入力項目**:
  - メールアドレス
  - パスワード
- **動作**:
  - ログイン成功時: 顧客一覧画面（/clientlist）へ遷移
  - ログイン失敗時: エラーメッセージを表示

### 2.2 ユーザー一覧画面（UserList.razor）
- **パス**: `/userlist`
- **機能**: 登録ユーザーの一覧表示と検索
- **表示項目**:
  - ID
  - 名前
  - メールアドレス
  - 権限（管理者/一般ユーザー）
- **機能**:
  - 名前での検索
  - メールアドレスでの検索
  - ユーザーの新規追加
  - ユーザー情報の編集（名前をクリック）
- **デザイン**: ClientListと同様の2段表示形式

### 2.3 ユーザーフォーム（UserForm.razor）
- **機能**: ユーザー情報の登録・編集
- **入力項目**:
  - 名前（必須）
  - メールアドレス（必須）
  - パスワード（必須）
  - 権限（必須、ドロップダウンで選択）
- **デザイン**: ClientFormと同様のフォームレイアウト

## 3. メニュー構成

### 3.1 メニュー項目
1. 顧客管理（/clientlist）
2. 車両管理（/vehiclelist）
3. 車両データインポート（/vehicle-import）
4. ユーザー管理（/userlist）
5. ログアウト（/）

### 3.2 権限制御（未実装）
- 管理者（Role=2）: 全メニュー表示
- 一般ユーザー（Role=1）: ユーザー管理メニューを非表示

## 4. サンプルデータ

システム初期化時に以下のユーザーが自動作成される：

| 名前 | メールアドレス | パスワード | 権限 |
|-----|--------------|-----------|------|
| 管理者 | admin@example.com | admin123 | 管理者 |
| 一般ユーザー | user@example.com | user123 | 一般ユーザー |
| 山田太郎 | yamada@example.com | yamada123 | 一般ユーザー |

## 5. データベース更新

### 5.1 マイグレーション
既存のUsersテーブルに新しいカラムを追加するため、以下の処理を実装：

1. Usersテーブルの存在確認
2. テーブルが存在しない場合は新規作成
3. 既存テーブルの場合はPasswordとRoleカラムの追加

### 5.2 データベース初期化
`Server/Program.cs`でデータベース初期化時に以下を実行：
- Usersテーブルの作成または更新
- サンプルユーザーの登録

## 6. 今後の実装予定

### 6.1 認証・認可機能
- JWT（JSON Web Token）による認証実装
- APIエンドポイントの保護
- セッション管理

### 6.2 権限制御
- メニューの権限別表示制御
- 画面アクセスの権限チェック
- API呼び出しの権限確認

### 6.3 セキュリティ強化
- パスワードのハッシュ化（BCrypt等）
- パスワードポリシーの実装
- ログイン試行回数制限

## 7. 技術仕様

### 7.1 使用技術
- Blazor WebAssembly（クライアント）
- ASP.NET Core（サーバー）
- Entity Framework Core（ORM）
- SQLite（データベース）
- Syncfusion Blazor Components（UI）

### 7.2 ファイル構成
```
Client/
├── Pages/
│   ├── Index.razor          # ログイン画面
│   ├── UserList.razor       # ユーザー一覧
│   └── UserList.razor.cs    # ユーザー一覧のコードビハインド
├── Shared/
│   └── UserForm.razor       # ユーザーフォーム
└── Layout/
    └── MainLayout.razor     # メニュー定義

Server/
├── Program.cs               # データベース初期化
└── Services/
    └── DbInitializer.cs     # サンプルデータ登録

Shared/
└── Models/
    └── User.cs              # ユーザーモデル
```

## 8. 注意事項

1. **パスワード管理**: 現在はパスワードを平文で保存しているため、本番環境では必ずハッシュ化を実装すること
2. **データベース更新**: 既存データベースがある場合は、`Server/Data/crm01.db`を削除して再起動するか、手動でマイグレーションを実行する必要がある
3. **権限制御**: メニューとAPIの権限制御は未実装のため、今後の実装が必要