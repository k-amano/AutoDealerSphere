@page "/invoice/detail/{InvoiceId:int}"
@using Syncfusion.Blazor.Popups
@using Syncfusion.Blazor.Navigations

<SfBreadcrumb>
    <BreadcrumbItems>
        <BreadcrumbItem IconCss="e-icons e-home" Url="/"/>
        <BreadcrumbItem Text="請求書管理" Url="/invoicelist"/>
        <BreadcrumbItem Text="詳細" Url="./"/>
    </BreadcrumbItems>
</SfBreadcrumb>

<h2>請求書詳細</h2>

<div class="@MainContentClass">

    <div class="invoice-info">
        <h3>基本情報</h3>
        <div class="info-grid">
            <div class="info-row">
                <span class="info-label">請求書番号:</span>
                <span class="info-value">@InvoiceNumberDisplay</span>
            </div>
            <div class="info-row">
                <span class="info-label">顧客:</span>
                <span class="info-value">@ClientNameDisplay</span>
            </div>
            <div class="info-row">
                <span class="info-label">車両:</span>
                <span class="info-value">@VehicleDisplay</span>
            </div>
            <div class="info-row">
                <span class="info-label">請求日:</span>
                <span class="info-value">@InvoiceDateDisplay</span>
            </div>
            <div class="info-row">
                <span class="info-label">作業完了日:</span>
                <span class="info-value">@WorkCompletedDateDisplay</span>
            </div>
            <div class="@NextInspectionRowClass">
                <span class="info-label">次回車検日:</span>
                <span class="info-value">@NextInspectionDateDisplay</span>
            </div>
            <div class="@MileageRowClass">
                <span class="info-label">走行距離:</span>
                <span class="info-value">@MileageDisplay km</span>
            </div>
        </div>
        <div class="form-buttons">
            <SfButton @onclick="OpenBasicInfoDialog" CssClass="e-primary">基本編集</SfButton>
        </div>
    </div>

    <div class="invoice-details @InvoiceDetailsClass">
        <h3>明細一覧</h3>
        <SfGrid DataSource="@RegularDetails" AllowSorting="false" AllowPaging="false" CssClass="invoice-detail-grid two-line-grid">
            <GridTemplates>
                <RowTemplate>
                    @{
                        var detail = context as AutoDealerSphere.Shared.Models.InvoiceDetail;
                        <td colspan="7">
                            <div class="detail-row">
                                <span class="detail-name">
                                    <span @onclick="() => EditDetail(detail)" class="grid-link">
                                        @detail.ItemName
                                    </span>
                                </span>
                                <span class="detail-type">@detail.Type</span>
                                <span class="detail-repair">@detail.RepairMethod</span>
                                <span class="detail-quantity">@($"{detail.Quantity:N2}")</span>
                                <span class="detail-unitprice">¥@($"{detail.UnitPrice:N0}")</span>
                                <span class="detail-labor">¥@($"{detail.LaborCost:N0}")</span>
                                <span class="detail-subtotal">¥@($"{detail.SubTotal:N0}")</span>
                            </div>
                        </td>
                    }
                </RowTemplate>
                <EmptyRecordTemplate>
                    <div class="empty-record">明細データがありません</div>
                </EmptyRecordTemplate>
            </GridTemplates>
            <GridColumns>
                <GridColumn Field="@nameof(AutoDealerSphere.Shared.Models.InvoiceDetail.ItemName)" HeaderText="項目名" Width="29%"></GridColumn>
                <GridColumn Field="@nameof(AutoDealerSphere.Shared.Models.InvoiceDetail.Type)" HeaderText="タイプ" Width="10%"></GridColumn>
                <GridColumn Field="@nameof(AutoDealerSphere.Shared.Models.InvoiceDetail.RepairMethod)" HeaderText="修理方法" Width="10%"></GridColumn>
                <GridColumn Field="@nameof(AutoDealerSphere.Shared.Models.InvoiceDetail.Quantity)" HeaderText="数量" Width="10%"></GridColumn>
                <GridColumn Field="@nameof(AutoDealerSphere.Shared.Models.InvoiceDetail.UnitPrice)" HeaderText="単価" Width="10%"></GridColumn>
                <GridColumn Field="@nameof(AutoDealerSphere.Shared.Models.InvoiceDetail.LaborCost)" HeaderText="工賃" Width="10%"></GridColumn>
                <GridColumn Field="@nameof(AutoDealerSphere.Shared.Models.InvoiceDetail.SubTotal)" HeaderText="小計"></GridColumn>
            </GridColumns>
        </SfGrid>
        <div class="form-buttons">
            <SfButton @onclick="OpenDetailDialog" CssClass="e-success">明細追加</SfButton>
        </div>
    </div>

    <div class="statutory-fees @StatutoryFeesClass">
        <h3>法定費用一覧</h3>
        <SfGrid DataSource="@StatutoryFees" AllowSorting="false" AllowPaging="false" CssClass="statutory-fee-grid">
            <GridColumns>
                <GridColumn Field="@nameof(AutoDealerSphere.Shared.Models.InvoiceDetail.ItemName)" HeaderText="項目名" Width="300"></GridColumn>
                <GridColumn Field="@nameof(AutoDealerSphere.Shared.Models.InvoiceDetail.SubTotal)" HeaderText="金額" Width="150">
                    <Template>
                        @{
                            var detail = (context as AutoDealerSphere.Shared.Models.InvoiceDetail);
                            <span>¥@($"{detail?.SubTotal:N0}")</span>
                        }
                    </Template>
                </GridColumn>
            </GridColumns>
            <GridTemplates>
                <EmptyRecordTemplate>
                    <div class="empty-record">法定費用データがありません</div>
                </EmptyRecordTemplate>
            </GridTemplates>
        </SfGrid>
        <div class="form-buttons">
            <SfButton @onclick="OpenStatutoryFeeDialog" CssClass="e-info">法定費用</SfButton>
        </div>
    </div>

    <div class="invoice-summary @InvoiceSummaryClass">
        <h3>合計</h3>
        <div class="summary-grid">
            <div class="summary-row">
                <span class="summary-label">小計:</span>
                <span class="summary-value">¥@($"{SubTotal:N0}")</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">消費税（@(TaxRate)%）:</span>
                <span class="summary-value">¥@($"{Tax:N0}")</span>
            </div>
            <div class="summary-row total">
                <span class="summary-label">合計金額:</span>
                <span class="summary-value">¥@($"{Total:N0}")</span>
            </div>
        </div>
    </div>

    <div class="invoice-notes @InvoiceNotesClass">
        <h3>備考</h3>
        <p>@NotesDisplay</p>
    </div>

    <div class="form-buttons">
        <SfButton @onclick="NavigateToInvoiceList">一覧へ戻る</SfButton>
        @if (HasPreviousInvoice)
        {
            <SfButton @onclick="NavigateToPreviousInvoice" CssClass="e-info">前ページ</SfButton>
        }
        @if (HasNextInvoice)
        {
            <SfButton @onclick="NavigateToNextInvoice" CssClass="e-info">次ページ</SfButton>
        }
        @if (IsFirstInvoice)
        {
            <SfButton @onclick="ExportExcel" CssClass="e-success">Excel出力</SfButton>
        }
        <SfButton @onclick="OpenAddInvoiceDialog" CssClass="e-warning">請求書追加</SfButton>
        <SfButton @onclick="ShowDeleteConfirmation" CssClass="e-danger">削除実行</SfButton>
    </div>
</div>

<div class="@LoadingContentClass">
    <p>読み込み中...</p>
</div>

<!-- 基本情報編集ダイアログ -->
<AutoDealerSphere.Client.Components.InvoiceBasicInfoDialog @ref="_basicInfoDialog" OnSave="OnBasicInfoSaved" />

<!-- 明細編集ダイアログ -->
<AutoDealerSphere.Client.Components.InvoiceDetailDialog @ref="_detailDialog" OnSave="OnDetailSaved" />

<!-- 法定費用選択ダイアログ -->
<AutoDealerSphere.Client.Components.StatutoryFeeDialog @ref="_statutoryFeeDialog" OnSave="OnStatutoryFeeSaved" />

<!-- 削除確認ダイアログ -->
<SfDialog Width="250px" ShowCloseIcon="true" IsModal="true" @bind-Visible="@_showDeleteConfirmation">
    <DialogTemplates>
        <Header> 確認 </Header>
        <Content> 削除してもよろしいですか? </Content>
    </DialogTemplates>
    <DialogButtons>
        <DialogButton Content="実行" IsPrimary="true" OnClick="@DeleteInvoice" />
        <DialogButton Content="キャンセル" OnClick="@CloseDeleteConfirmation" />
    </DialogButtons>
</SfDialog>