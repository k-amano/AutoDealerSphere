@page "/invoice/detail/{InvoiceId:int}"

<SfBreadcrumb>
    <BreadcrumbItems>
        <BreadcrumbItem IconCss="e-icons e-home" Url="/"/>
        <BreadcrumbItem Text="請求書管理" Url="/invoicelist"/>
        <BreadcrumbItem Text="詳細" Url="./"/>
    </BreadcrumbItems>
</SfBreadcrumb>

<h2>請求書詳細</h2>

<div class="@MainContentClass">
    <div class="detail-header">
        <div class="button-group">
            <div class="@NewInvoiceButtonClass">
                <p>請求書の基本情報を登録してください。</p>
                <SfButton @onclick="OpenBasicInfoDialog" CssClass="e-primary">新規登録</SfButton>
            </div>
            <div class="@ExistingInvoiceButtonClass">
                <SfButton @onclick="OpenBasicInfoDialog" CssClass="e-primary">基本編集</SfButton>
                <SfButton @onclick="OpenDetailDialog" CssClass="e-success">明細追加</SfButton>
                <SfButton @onclick="ExportExcel">Excel出力</SfButton>
                <SfButton @onclick="DeleteInvoice" CssClass="e-danger">削除実行</SfButton>
            </div>
        </div>
    </div>

    <div class="invoice-info">
        <h3>基本情報</h3>
        <div class="info-grid">
            <div class="info-row">
                <span class="info-label">請求書番号:</span>
                <span class="info-value">@InvoiceNumberDisplay</span>
            </div>
            <div class="info-row">
                <span class="info-label">顧客:</span>
                <span class="info-value">@ClientNameDisplay</span>
            </div>
            <div class="info-row">
                <span class="info-label">車両:</span>
                <span class="info-value">@VehicleDisplay</span>
            </div>
            <div class="info-row">
                <span class="info-label">請求日:</span>
                <span class="info-value">@InvoiceDateDisplay</span>
            </div>
            <div class="info-row">
                <span class="info-label">作業完了日:</span>
                <span class="info-value">@WorkCompletedDateDisplay</span>
            </div>
            <div class="@NextInspectionRowClass">
                <span class="info-label">次回車検日:</span>
                <span class="info-value">@NextInspectionDateDisplay</span>
            </div>
            <div class="@MileageRowClass">
                <span class="info-label">走行距離:</span>
                <span class="info-value">@MileageDisplay km</span>
            </div>
        </div>
    </div>

    <div class="invoice-details @InvoiceDetailsClass">
        <h3>明細一覧</h3>
        <SfGrid DataSource="@_invoice?.InvoiceDetails" AllowSorting="false" AllowPaging="false">
            <GridColumns>
                <GridColumn Field="@nameof(AutoDealerSphere.Shared.Models.InvoiceDetail.ItemName)" HeaderText="項目名" Width="200"></GridColumn>
                <GridColumn Field="@nameof(AutoDealerSphere.Shared.Models.InvoiceDetail.Type)" HeaderText="タイプ" Width="120"></GridColumn>
                <GridColumn Field="@nameof(AutoDealerSphere.Shared.Models.InvoiceDetail.RepairMethod)" HeaderText="修理方法" Width="150"></GridColumn>
                <GridColumn Field="@nameof(AutoDealerSphere.Shared.Models.InvoiceDetail.Quantity)" HeaderText="数量" Width="80" Format="N2"></GridColumn>
                <GridColumn Field="@nameof(AutoDealerSphere.Shared.Models.InvoiceDetail.UnitPrice)" HeaderText="単価" Width="100">
                    <Template>
                        @{
                            var detail = (context as AutoDealerSphere.Shared.Models.InvoiceDetail);
                            <span>¥@($"{detail?.UnitPrice:N0}")</span>
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(AutoDealerSphere.Shared.Models.InvoiceDetail.LaborCost)" HeaderText="工賃" Width="100">
                    <Template>
                        @{
                            var detail = (context as AutoDealerSphere.Shared.Models.InvoiceDetail);
                            <span>¥@($"{detail?.LaborCost:N0}")</span>
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(AutoDealerSphere.Shared.Models.InvoiceDetail.IsTaxable)" HeaderText="課税" Width="60">
                    <Template>
                        @{
                            var detail = (context as AutoDealerSphere.Shared.Models.InvoiceDetail);
                            <span>@(detail?.IsTaxable == true ? "○" : "×")</span>
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(AutoDealerSphere.Shared.Models.InvoiceDetail.SubTotal)" HeaderText="小計" Width="100">
                    <Template>
                        @{
                            var detail = (context as AutoDealerSphere.Shared.Models.InvoiceDetail);
                            <span>¥@($"{detail?.SubTotal:N0}")</span>
                        }
                    </Template>
                </GridColumn>
                <GridColumn HeaderText="操作" Width="120">
                    <Template>
                        @{
                            var detail = (context as AutoDealerSphere.Shared.Models.InvoiceDetail);
                            <SfButton @onclick="() => EditDetail(detail)">編集</SfButton>
                            <SfButton @onclick="() => DeleteDetail(detail)" CssClass="e-danger">削除</SfButton>
                        }
                    </Template>
                </GridColumn>
            </GridColumns>
            <GridTemplates>
                <EmptyRecordTemplate>
                    <div class="empty-record">明細データがありません</div>
                </EmptyRecordTemplate>
            </GridTemplates>
        </SfGrid>
    </div>

    <div class="invoice-summary @InvoiceSummaryClass">
        <h3>合計</h3>
        <div class="summary-grid">
            <div class="summary-row">
                <span class="summary-label">課税対象小計:</span>
                <span class="summary-value">¥@($"{TaxableSubTotal:N0}")</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">非課税小計:</span>
                <span class="summary-value">¥@($"{NonTaxableSubTotal:N0}")</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">消費税（@(TaxRate)%）:</span>
                <span class="summary-value">¥@($"{Tax:N0}")</span>
            </div>
            <div class="summary-row total">
                <span class="summary-label">合計金額:</span>
                <span class="summary-value">¥@($"{Total:N0}")</span>
            </div>
        </div>
    </div>

    <div class="invoice-notes @InvoiceNotesClass">
        <h3>備考</h3>
        <p>@NotesDisplay</p>
    </div>

    <div class="form-buttons">
        <SfButton @onclick="NavigateToInvoiceList">一覧へ戻る</SfButton>
    </div>
</div>

<div class="@LoadingContentClass">
    <p>読み込み中...</p>
</div>

<!-- 基本情報編集ダイアログ -->
<AutoDealerSphere.Client.Components.InvoiceBasicInfoDialog @ref="_basicInfoDialog" OnSave="OnBasicInfoSaved" />

<!-- 明細編集ダイアログ -->
<AutoDealerSphere.Client.Components.InvoiceDetailDialog @ref="_detailDialog" OnSave="OnDetailSaved" />