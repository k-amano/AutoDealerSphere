@page "/vehiclelist"
@inject NavigationManager NavigationManager
@inject HttpClient Http
@using Syncfusion.Blazor.Data
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Navigations
@using Syncfusion.Blazor.DataForm
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Calendars
@using Syncfusion.Blazor.Inputs
@using Newtonsoft.Json
@using AutoDealerSphere.Shared.Models

<SfBreadcrumb>
    <BreadcrumbItems>
        <BreadcrumbItem IconCss="e-icons e-home" Url="/" />
        <BreadcrumbItem Text="車両管理" Url="/" />
    </BreadcrumbItems>
</SfBreadcrumb>

<h2>車両管理</h2>
<h3>車両一覧</h3>

<div class="search-form">
    <EditForm Model="@Search" OnValidSubmit="() => OnSearch(Search)">
        <DataAnnotationsValidator />
        <div class="form">
            <div class="form-row">
                <label>車名・型式</label>
                <SfTextBox @bind-Value="Search.VehicleNameOrModel" Placeholder="車名または型式"></SfTextBox>
            </div>
            <div class="form-row">
                <label>ナンバー</label>
                <SfTextBox @bind-Value="Search.LicensePlate" Placeholder="ナンバープレート"></SfTextBox>
            </div>
            <div class="form-row">
                <label>所有者</label>
                <SfTextBox @bind-Value="Search.ClientName" Placeholder="所有者名"></SfTextBox>
            </div>
            <div class="form-row">
                <label>車検満了日</label>
                <div class="date-range">
                    <SfDatePicker TValue="DateTime?" @bind-Value="Search.InspectionExpiryDateFrom" 
                        Placeholder="開始日" Format="yyyy/MM/dd"></SfDatePicker>
                    <span class="date-separator">～</span>
                    <SfDatePicker TValue="DateTime?" @bind-Value="Search.InspectionExpiryDateTo" 
                        Placeholder="終了日" Format="yyyy/MM/dd"></SfDatePicker>
                </div>
            </div>
            <div class="form-buttons">
                <SfButton Type="ButtonType.Submit">検索</SfButton>
            </div>
        </div>
    </EditForm>
</div>
<br />

<div class="toolbar">
    <SfButton OnClick="AddVehicle" CssClass="e-primary">新規追加</SfButton>
</div>
<br />

@if (Vehicles.Any())
{
    <SfGrid DataSource="@Vehicles" AllowPaging="true" AllowSorting="true" AllowMultiSorting="true" CssClass="two-line-grid">
        <GridTemplates>
            <RowTemplate>
                @{
                    var vehicle = context as Vehicle;
                    <td colspan="8">
                        <div class="vehicle-row">
                            <div class="row-line1">
                                <span class="vehicle-id">@vehicle.Id</span>
                                <span class="vehicle-plate">
                                    <span @onclick="() => EditVehicleFromContext(context)" class="grid-link">
                                        @GetLicensePlateFromContext(context)
                                    </span>
                                </span>
                                <span class="vehicle-name">@vehicle.VehicleName</span>
                                <span class="vehicle-model">@vehicle.VehicleModel</span>
                                <span class="vehicle-client">@GetClientNameFromContext(context)</span>
                            </div>
                            <div class="row-line2">
                                <span class="vehicle-dates">
                                    初度登録: @vehicle.FirstRegistrationDate?.ToString("yyyy/MM/dd")
                                    車検満了: @vehicle.InspectionExpiryDate?.ToString("yyyy/MM/dd")
                                </span>
                                @if (vehicle.Mileage != null)
                                {
                                    <span class="vehicle-mileage">走行距離: @($"{vehicle.Mileage:N0} km")</span>
                                }
                            </div>
                        </div>
                    </td>
                }
            </RowTemplate>
        </GridTemplates>
        <GridColumns>
            <GridColumn Field="@nameof(Vehicle.Id)" HeaderText="ID"></GridColumn>
            <GridColumn Field="@nameof(Vehicle.VehicleName)" HeaderText="車名"></GridColumn>
            <GridColumn Field="@nameof(Vehicle.VehicleModel)" HeaderText="型式"></GridColumn>
            <GridColumn Field="@nameof(Vehicle.LicensePlateNumber)" HeaderText="ナンバー"></GridColumn>
            <GridColumn Field="@nameof(Vehicle.ClientId)" HeaderText="所有者"></GridColumn>
            <GridColumn Field="@nameof(Vehicle.FirstRegistrationDate)" HeaderText="初度登録"></GridColumn>
            <GridColumn Field="@nameof(Vehicle.InspectionExpiryDate)" HeaderText="車検満了日"></GridColumn>
            <GridColumn Field="@nameof(Vehicle.Mileage)" HeaderText="走行距離"></GridColumn>
        </GridColumns>
    </SfGrid>
}
else
{
    <p class="error-message">車両情報が見つかりません。</p>
}

@code {
}