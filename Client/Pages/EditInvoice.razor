@page "/invoice/{InvoiceId:int}"
@inject NavigationManager NavigationManager
@inject HttpClient Http
@using Syncfusion.Blazor.DataForm
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Calendars
@using System.ComponentModel.DataAnnotations
@using Syncfusion.Blazor.Navigations
@using AutoDealerSphere.Shared.Models

<SfBreadcrumb>
    <BreadcrumbItems>
        <BreadcrumbItem IconCss="e-icons e-home" Url="/"/>
        <BreadcrumbItem Text="請求書管理" Url="/invoicelist"/>
        <BreadcrumbItem Text="編集" Url="./"/>
    </BreadcrumbItems>
</SfBreadcrumb>

<h2>請求書管理</h2>
<h3>@(InvoiceId == 0 ? "新規作成" : "編集")</h3>

@if (_initialized)
{
    @if (_invoice != null)
    {
        <EditForm Model="@_invoice" OnValidSubmit="OnValidSubmit">
            <DataAnnotationsValidator />
            
            <div class="form">
                <h4>基本情報</h4>
                <div class="form-row">
                    <label>請求書番号</label>
                    <SfTextBox @bind-Value="_invoice.InvoiceNumber" Readonly="true"></SfTextBox>
                </div>
                
                <div class="form-row">
                    <label class="required">顧客</label>
                    <SfDropDownList TValue="int" TItem="AutoDealerSphere.Shared.Models.Client" 
                        @bind-Value="@_invoice.ClientId" 
                        DataSource="@_clients"
                        Placeholder="顧客を選択"
                        AllowFiltering="true">
                        <DropDownListFieldSettings Value="Id" Text="Name"></DropDownListFieldSettings>
                        <DropDownListEvents TValue="int" TItem="AutoDealerSphere.Shared.Models.Client" ValueChange="OnClientChanged"></DropDownListEvents>
                    </SfDropDownList>
                    <ValidationMessage For="@(() => _invoice.ClientId)" />
                </div>
                
                <div class="form-row">
                    <label class="required">車両</label>
                    <SfDropDownList TValue="int" TItem="Vehicle" 
                        @bind-Value="@_invoice.VehicleId" 
                        DataSource="@_vehicles"
                        Placeholder="車両を選択"
                        Enabled="@(_vehicles != null && _vehicles.Any())">
                        <DropDownListFieldSettings Value="Id" Text="VehicleName"></DropDownListFieldSettings>
                    </SfDropDownList>
                    <ValidationMessage For="@(() => _invoice.VehicleId)" />
                </div>
                
                <div class="form-row">
                    <label class="required">請求日</label>
                    <SfDatePicker @bind-Value="_invoice.InvoiceDate" Format="yyyy/MM/dd"></SfDatePicker>
                    <ValidationMessage For="@(() => _invoice.InvoiceDate)" />
                </div>
                
                <div class="form-row">
                    <label class="required">作業完了日</label>
                    <SfDatePicker @bind-Value="_invoice.WorkCompletedDate" Format="yyyy/MM/dd"></SfDatePicker>
                    <ValidationMessage For="@(() => _invoice.WorkCompletedDate)" />
                </div>
                
                <div class="form-row">
                    <label>次回車検日</label>
                    <SfDatePicker @bind-Value="_invoice.NextInspectionDate" Format="yyyy/MM/dd"></SfDatePicker>
                </div>
                
                <div class="form-row">
                    <label>走行距離</label>
                    <SfNumericTextBox @bind-Value="_invoice.Mileage" Placeholder="走行距離" Format="N0"></SfNumericTextBox>
                </div>
                
                <h4>明細</h4>
                <div class="detail-grid">
                    <SfButton @onclick="AddDetail" CssClass="e-primary">明細追加</SfButton>
                    <br /><br />
                    
                    <SfGrid DataSource="@_invoice.InvoiceDetails" AllowSorting="false" AllowPaging="false">
                        <GridColumns>
                            <GridColumn Field="@nameof(InvoiceDetail.ItemName)" HeaderText="項目名" Width="200">
                                <EditTemplate Context="editContext">
                                    @{
                                        var detail = (editContext as InvoiceDetail);
                                        <SfTextBox @bind-Value="detail.ItemName"></SfTextBox>
                                    }
                                </EditTemplate>
                            </GridColumn>
                            <GridColumn Field="@nameof(InvoiceDetail.Type)" HeaderText="タイプ" Width="120">
                                <EditTemplate Context="editContext">
                                    @{
                                        var detail = (editContext as InvoiceDetail);
                                        <SfTextBox @bind-Value="detail.Type"></SfTextBox>
                                    }
                                </EditTemplate>
                            </GridColumn>
                            <GridColumn Field="@nameof(InvoiceDetail.RepairMethod)" HeaderText="修理方法" Width="150">
                                <EditTemplate Context="editContext">
                                    @{
                                        var detail = (editContext as InvoiceDetail);
                                        <SfTextBox @bind-Value="detail.RepairMethod"></SfTextBox>
                                    }
                                </EditTemplate>
                            </GridColumn>
                            <GridColumn Field="@nameof(InvoiceDetail.Quantity)" HeaderText="数量" Width="80">
                                <EditTemplate Context="editContext">
                                    @{
                                        var detail = (editContext as InvoiceDetail);
                                        <SfNumericTextBox @bind-Value="detail.Quantity" Format="N2" Min="0.01m" Max="9999.99m"></SfNumericTextBox>
                                    }
                                </EditTemplate>
                            </GridColumn>
                            <GridColumn Field="@nameof(InvoiceDetail.UnitPrice)" HeaderText="単価" Width="100">
                                <EditTemplate Context="editContext">
                                    @{
                                        var detail = (editContext as InvoiceDetail);
                                        <SfNumericTextBox @bind-Value="detail.UnitPrice" Format="¥#,##0" Min="0m"></SfNumericTextBox>
                                    }
                                </EditTemplate>
                            </GridColumn>
                            <GridColumn Field="@nameof(InvoiceDetail.LaborCost)" HeaderText="工賃" Width="100">
                                <EditTemplate Context="editContext">
                                    @{
                                        var detail = (editContext as InvoiceDetail);
                                        <SfNumericTextBox @bind-Value="detail.LaborCost" Format="¥#,##0" Min="0m"></SfNumericTextBox>
                                    }
                                </EditTemplate>
                            </GridColumn>
                            <GridColumn Field="@nameof(InvoiceDetail.IsTaxable)" HeaderText="課税" Width="60">
                                <Template Context="templateContext">
                                    @{
                                        var detail = (templateContext as InvoiceDetail);
                                        <SfCheckBox @bind-Checked="detail.IsTaxable"></SfCheckBox>
                                    }
                                </Template>
                            </GridColumn>
                            <GridColumn Field="@nameof(InvoiceDetail.SubTotal)" HeaderText="小計" Width="100">
                                <Template Context="templateContext">
                                    @{
                                        var detail = (templateContext as InvoiceDetail);
                                        <span>¥@($"{detail.SubTotal:N0}")</span>
                                    }
                                </Template>
                            </GridColumn>
                            <GridColumn HeaderText="操作" Width="80">
                                <Template Context="templateContext">
                                    @{
                                        var detail = (templateContext as InvoiceDetail);
                                        <SfButton @onclick="() => RemoveDetail(detail)" CssClass="e-danger e-btn-sm">削除</SfButton>
                                    }
                                </Template>
                            </GridColumn>
                        </GridColumns>
                    </SfGrid>
                </div>
                
                <h4>合計</h4>
                <div class="form-row">
                    <label>課税対象小計</label>
                    <span class="total-amount">¥@($"{_invoice.TaxableSubTotal:N0}")</span>
                </div>
                <div class="form-row">
                    <label>非課税小計</label>
                    <span class="total-amount">¥@($"{_invoice.NonTaxableSubTotal:N0}")</span>
                </div>
                <div class="form-row">
                    <label>消費税（@(_invoice.TaxRate)%）</label>
                    <span class="total-amount">¥@($"{_invoice.Tax:N0}")</span>
                </div>
                <div class="form-row">
                    <label><strong>合計金額</strong></label>
                    <span class="total-amount"><strong>¥@($"{_invoice.Total:N0}")</strong></span>
                </div>
                
                <div class="form-row">
                    <label>備考</label>
                    <SfTextBox @bind-Value="_invoice.Notes" Multiline="true" Placeholder="備考"></SfTextBox>
                </div>
                
                <div class="form-buttons">
                    <SfButton Type="ButtonType.Submit" IsPrimary="true">保存</SfButton>
                    @if (InvoiceId > 0)
                    {
                        <SfButton @onclick="OnDeleteClick" CssClass="e-danger">削除</SfButton>
                    }
                    <SfButton @onclick="OnCancelClick">キャンセル</SfButton>
                </div>
            </div>
        </EditForm>
    }
    else
    {
        <p class="error-message">請求書情報が見つかりません。</p>
    }
}

<style>
    .detail-grid {
        margin: 20px 0;
    }
    
    .total-amount {
        font-size: 1.1em;
        font-weight: 500;
    }
</style>

@code {
}