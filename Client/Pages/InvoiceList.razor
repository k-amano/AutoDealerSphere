@page "/invoicelist"
@inject NavigationManager NavigationManager
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@using Syncfusion.Blazor.Data
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Navigations
@using Syncfusion.Blazor.DataForm
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Calendars
@using Syncfusion.Blazor.Popups
@using Newtonsoft.Json
@using AutoDealerSphere.Shared.Models
@using AutoDealerSphere.Client.Components

<SfBreadcrumb>
    <BreadcrumbItems>
        <BreadcrumbItem IconCss="e-icons e-home" Url="/" />
        <BreadcrumbItem Text="請求書管理" Url="/invoicelist" />
    </BreadcrumbItems>
</SfBreadcrumb>

<h2>請求書管理</h2>
<h3>請求書一覧</h3>

<div class="search-form">
    <EditForm Model="@Search" OnValidSubmit="() => OnSearch(Search)">
        <DataAnnotationsValidator />
        <div class="form">
            <div class="form-row">
                <label>請求書番号</label>
                <SfTextBox @bind-Value="Search.InvoiceNumber" Placeholder="請求書番号"></SfTextBox>
            </div>
            <div class="form-row">
                <label>顧客名</label>
                <SfTextBox @bind-Value="Search.ClientName" Placeholder="顧客名"></SfTextBox>
            </div>
            <div class="form-row">
                <label>請求日</label>
                <div class="date-range">
                    <SfDatePicker TValue="DateTime?" @bind-Value="Search.StartDate" 
                        Placeholder="開始日" Format="yyyy/MM/dd"></SfDatePicker>
                    <span class="date-separator">～</span>
                    <SfDatePicker TValue="DateTime?" @bind-Value="Search.EndDate" 
                        Placeholder="終了日" Format="yyyy/MM/dd"></SfDatePicker>
                </div>
            </div>
            <div class="form-buttons">
                <SfButton Type="ButtonType.Submit">検索</SfButton>
            </div>
        </div>
    </EditForm>
</div>
<br />

<div class="register-form">
    @if (HasClients)
    {
        <SfButton @onclick="@(() => OpenNewInvoiceDialog())" CssClass="e-primary">
            新規追加
        </SfButton>
    }
    else
    {
        <SfButton Disabled="true" title="顧客データがないため新規作成できません">
            新規追加
        </SfButton>
        <span class="text-warning ms-2">※ 先に顧客情報を登録してください</span>
    }
</div>
<br />

@if (SearchResults != null && SearchResults.Any())
{
    <SfGrid DataSource="@SearchResults" AllowSorting="true" AllowPaging="true" AllowFiltering="false" AllowTextWrap="true">
        <GridPageSettings PageSize="20"></GridPageSettings>
        <GridColumns>
            <GridColumn Field="@nameof(Invoice.Id)" HeaderText="ID" Width="10%"></GridColumn>
            <GridColumn Field="@nameof(Invoice.InvoiceNumber)" HeaderText="請求書番号" Width="15%">
                <Template>
                    @{
                        var invoice = (context as Invoice);
                        var displayNumber = invoice.Subnumber > 1 
                            ? $"{invoice.InvoiceNumber}-{invoice.Subnumber}" 
                            : invoice.InvoiceNumber;
                        <a href="@($"/invoice/detail/{invoice.Id}")" class="grid-link">@displayNumber</a>
                    }
                </Template>
            </GridColumn>
            <GridColumn HeaderText="顧客名" Width="25%">
                <Template>
                    @{
                        var invoice = (context as Invoice);
                        <span>@(invoice?.Client?.Name ?? "-")</span>
                    }
                </Template>
            </GridColumn>
            <GridColumn HeaderText="車名" Width="20%">
                <Template>
                    @{
                        var invoice = (context as Invoice);
                        <span>@(invoice?.Vehicle?.VehicleName ?? "-")</span>
                    }
                </Template>
            </GridColumn>
            <GridColumn Field="@nameof(Invoice.InvoiceDate)" HeaderText="請求日" Width="15%" Format="yyyy/MM/dd"></GridColumn>
            <GridColumn Field="@nameof(Invoice.Total)" HeaderText="合計金額" Width="15%" TextAlign="TextAlign.Right">
                <Template>
                    @{
                        var invoice = (context as Invoice);
                        <span>¥@($"{invoice.Total:N0}")</span>
                    }
                </Template>
            </GridColumn>
        </GridColumns>
    </SfGrid>
}
else
{
    <p class="error-message">請求書情報が見つかりません。</p>
}

<InvoiceBasicInfoDialog @ref="basicInfoDialog" OnSave="OnBasicInfoSaved" />

@code {
    private Invoice[]? Invoices;
    private Invoice[]? SearchResults;
    private InvoiceSearchModel Search = new InvoiceSearchModel();
    private bool HasClients = false;
    private InvoiceBasicInfoDialog? basicInfoDialog;
    private Invoice newInvoice = new Invoice();

    protected override async Task OnInitializedAsync()
    {
        await LoadInvoices();
        await CheckClients();
    }
    
    private async Task CheckClients()
    {
        var clients = await Http.GetFromJsonAsync<AutoDealerSphere.Shared.Models.Client[]>("api/Client");
        HasClients = clients != null && clients.Any();
    }

    private async Task LoadInvoices()
    {
        Invoices = await Http.GetFromJsonAsync<Invoice[]>("api/Invoices");
        SearchResults = Invoices;
    }

    private async Task OnSearch(InvoiceSearchModel search)
    {
        // 検索条件がすべて空の場合は全件表示
        if (string.IsNullOrWhiteSpace(search.InvoiceNumber) && 
            string.IsNullOrWhiteSpace(search.ClientName) &&
            !search.StartDate.HasValue &&
            !search.EndDate.HasValue)
        {
            SearchResults = Invoices;
        }
        else
        {
            // Invoicesから検索（常に全データから検索する）
            SearchResults = Invoices?.Where(i =>
                (string.IsNullOrWhiteSpace(search.InvoiceNumber) || i.InvoiceNumber.Contains(search.InvoiceNumber)) &&
                (string.IsNullOrWhiteSpace(search.ClientName) || (i.Client != null && i.Client.Name.Contains(search.ClientName))) &&
                (!search.StartDate.HasValue || i.InvoiceDate >= search.StartDate.Value) &&
                (!search.EndDate.HasValue || i.InvoiceDate <= search.EndDate.Value)
            ).ToArray();
        }
    }


    private async Task OnExportClick(int invoiceId)
    {
        try
        {
            var response = await Http.GetAsync($"api/Invoices/{invoiceId}/export");
            if (response.IsSuccessStatusCode)
            {
                var bytes = await response.Content.ReadAsByteArrayAsync();
                var contentDisposition = response.Content.Headers.ContentDisposition;
                var fileName = contentDisposition?.FileName?.Trim('"') ?? $"invoice_{invoiceId}_{DateTime.Now:yyyyMMdd}.xlsx";
                
                // JavaScript経由でファイルをダウンロード (MemoryStreamを使用)
                using var stream = new System.IO.MemoryStream(bytes);
                using var streamRef = new Microsoft.JSInterop.DotNetStreamReference(stream: stream);
                await JSRuntime.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
            }
            else
            {
                // エラーメッセージを表示（実際のアプリケーションでは適切なエラーハンドリングを実装）
                Console.WriteLine($"Excel export failed: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Excel export error: {ex.Message}");
        }
    }

    public class InvoiceSearchModel
    {
        public string? InvoiceNumber { get; set; }
        public string? ClientName { get; set; }
        public DateTime? StartDate { get; set; }
        public DateTime? EndDate { get; set; }
    }

    private async void OpenNewInvoiceDialog()
    {
        newInvoice = new Invoice
        {
            InvoiceNumber = GenerateInvoiceNumber(),
            InvoiceDate = DateTime.Now,
            WorkCompletedDate = DateTime.Now
        };
        if (basicInfoDialog != null)
        {
            await basicInfoDialog.Open(newInvoice);
        }
    }

    private string GenerateInvoiceNumber()
    {
        return string.Empty; // 空文字列を返してサーバー側で自動生成
    }

    private async Task OnBasicInfoSaved(Invoice invoice)
    {
        // 新規作成の場合、サーバーに保存
        var response = await Http.PostAsJsonAsync("api/Invoices", invoice);
        if (response.IsSuccessStatusCode)
        {
            var created = await response.Content.ReadFromJsonAsync<Invoice>();
            if (created != null)
            {
                NavigationManager.NavigateTo($"/invoice/detail/{created.Id}");
            }
        }
        else
        {
            // エラーハンドリング（実際のアプリケーションでは適切なエラー表示を実装）
            Console.WriteLine($"Failed to save invoice: {response.StatusCode}");
        }
    }
}