@using Syncfusion.Blazor.Popups
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Grids
@using AutoDealerSphere.Shared.Models
@using System.ComponentModel.DataAnnotations

<SfDialog @ref="_dialog" Width="600px" IsModal="true" ShowCloseIcon="true" @bind-Visible="_isVisible">
    <DialogTemplates>
        <Header>
            <span>@DialogTitle</span>
        </Header>
        <Content>
            @if (_currentStep == DialogStep.SelectPart)
            {
                <div class="part-selection">
                    <h4>部品を選択</h4>
                    <div class="search-section">
                        <div class="form-row">
                            <label>部品名で検索</label>
                            <SfTextBox @bind-Value="_partSearchText" Placeholder="部品名を入力" @oninput="@(async () => await SearchParts())"></SfTextBox>
                        </div>
                        <div class="form-row">
                            <label>タイプで絞込</label>
                            <SfDropDownList TValue="string" TItem="string" DataSource="@_partTypes" @bind-Value="_selectedType" Placeholder="すべて">
                                <DropDownListEvents TValue="string" TItem="string" ValueChange="@(async (e) => await FilterPartsByType())"></DropDownListEvents>
                            </SfDropDownList>
                        </div>
                    </div>
                    
                    <div class="parts-grid">
                        <SfGrid DataSource="@_filteredParts" AllowPaging="true" AllowSorting="false">
                            <GridPageSettings PageSize="10"></GridPageSettings>
                            <GridColumns>
                                <GridColumn Width="50">
                                    <Template>
                                        @{
                                            var part = (context as Part);
                                            <SfRadioButton Name="partSelection" Value="@part.Id.ToString()" @bind-Checked="_selectedPartIdString" @onchange="@(() => OnPartSelected(part.Id))"></SfRadioButton>
                                        }
                                    </Template>
                                </GridColumn>
                                <GridColumn Field="@nameof(Part.PartName)" HeaderText="部品名" Width="200"></GridColumn>
                                <GridColumn Field="@nameof(Part.Type)" HeaderText="タイプ" Width="120"></GridColumn>
                                <GridColumn Field="@nameof(Part.UnitPrice)" HeaderText="単価" Width="100">
                                    <Template>
                                        @{
                                            var part = (context as Part);
                                            <span>¥@($"{part?.UnitPrice:N0}")</span>
                                        }
                                    </Template>
                                </GridColumn>
                            </GridColumns>
                            <GridTemplates>
                                <EmptyRecordTemplate>
                                    <div class="empty-record">部品データがありません</div>
                                </EmptyRecordTemplate>
                            </GridTemplates>
                        </SfGrid>
                    </div>
                    
                    <div class="dialog-buttons">
                        <SfButton @onclick="ProceedToDetails" IsPrimary="true" Disabled="@(_selectedPartId == 0)">次へ</SfButton>
                        <SfButton @onclick="Cancel">キャンセル</SfButton>
                    </div>
                </div>
            }
            else if (_currentStep == DialogStep.EditDetails && _model != null)
            {
                <div class="detail-editing">
                    <h4>明細情報を入力</h4>
                    <EditForm Model="@_model" OnValidSubmit="OnValidSubmit">
                        <DataAnnotationsValidator />
                        <ValidationSummary />
                        
                        <div class="form-row">
                            <label>選択部品</label>
                            <span class="selected-part">@_model.ItemName</span>
                        </div>
                        
                        <div class="form-row">
                            <label>タイプ</label>
                            <span class="selected-type">@_model.Type</span>
                        </div>
                        
                        <div class="form-row">
                            <label>修理方法</label>
                            <SfDropDownList TValue="string" TItem="RepairMethodItem" DataSource="@_repairMethods" 
                                @bind-Value="_model.RepairMethod" Placeholder="修理方法を選択">
                                <DropDownListFieldSettings Text="Text" Value="Value"></DropDownListFieldSettings>
                            </SfDropDownList>
                        </div>
                        
                        <div class="form-row">
                            <label class="required">数量</label>
                            <SfNumericTextBox @bind-Value="_model.Quantity" Format="N2" Min="0.01m" Max="9999.99m" @onchange="CalculateSubTotal"></SfNumericTextBox>
                            <ValidationMessage For="@(() => _model.Quantity)" />
                        </div>
                        
                        <div class="form-row">
                            <label class="required">単価</label>
                            <SfNumericTextBox @bind-Value="_model.UnitPrice" Format="¥#,##0" Min="0m" @onchange="CalculateSubTotal"></SfNumericTextBox>
                            <ValidationMessage For="@(() => _model.UnitPrice)" />
                        </div>
                        
                        <div class="form-row">
                            <label>工賃</label>
                            <SfNumericTextBox @bind-Value="_model.LaborCost" Format="¥#,##0" Min="0m" @onchange="CalculateSubTotal"></SfNumericTextBox>
                        </div>
                        
                        <div class="form-row">
                            <label>課税</label>
                            <SfCheckBox @bind-Checked="_model.IsTaxable"></SfCheckBox>
                        </div>
                        
                        <div class="form-row">
                            <label>小計</label>
                            <span class="subtotal">¥@($"{_subTotal:N0}")</span>
                        </div>
                        
                        <div class="dialog-buttons">
                            <SfButton @onclick="BackToPartSelection">戻る</SfButton>
                            <SfButton Type="ButtonType.Submit" IsPrimary="true">保存</SfButton>
                            <SfButton @onclick="Cancel">キャンセル</SfButton>
                        </div>
                    </EditForm>
                </div>
            }
        </Content>
    </DialogTemplates>
</SfDialog>

<style>
    .part-selection, .detail-editing {
        padding: 10px;
    }
    
    .search-section {
        margin-bottom: 20px;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 5px;
    }
    
    .parts-grid {
        margin-bottom: 20px;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .form-row {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        gap: 10px;
    }
    
    .form-row label {
        width: 100px;
        color: #333;
    }
    
    .form-row .e-input-group,
    .form-row .e-numerictextbox,
    .form-row .e-ddl {
        flex: 1;
        max-width: 300px;
    }
    
    .selected-part, .selected-type {
        font-weight: 500;
        color: #333;
    }
    
    .subtotal {
        font-size: 1.1em;
        font-weight: 500;
        color: #333;
    }
    
    .dialog-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
    }
    
    .required::after {
        content: "必須";
        color: #ffffff;
        background: #cc0000;
        font-size: 0.8em;
        padding: 0.3em;
        border-radius: 0.5em;
        margin-left: 0.3em;
    }
    
    .empty-record {
        padding: 20px;
        text-align: center;
        color: #666;
    }
</style>